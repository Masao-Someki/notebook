<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.2" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="Example"><meta name="apple-mobile-web-app-title" content="Example"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileColor" content="#3eaf7c"><meta name="theme-color" content="#3eaf7c"><title>OWSM finetuning with custom dataset | ESPnet-Example</title><meta name="description" content="Example notebooks for ESPnet">
    <link rel="preload" href="/notebook/assets/style-cp41dQ25.css" as="style"><link rel="stylesheet" href="/notebook/assets/style-cp41dQ25.css">
    <link rel="modulepreload" href="/notebook/assets/app-FOR18dDf.js"><link rel="modulepreload" href="/notebook/assets/finetune_owsm.html-oRbSv_3K.js"><link rel="modulepreload" href="/notebook/assets/finetune_owsm.html-BKHMtCfm.js">
    <link rel="prefetch" href="/notebook/assets/index.html-XAvCBsD6.js" as="script"><link rel="prefetch" href="/notebook/assets/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html-KBtpWdkS.js" as="script"><link rel="prefetch" href="/notebook/assets/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html-ojQTonzi.js" as="script"><link rel="prefetch" href="/notebook/assets/SpokenLanguageUnderstanding_CMU_11492_692_Spring2023(Assignment6).html-k7t3PiyY.js" as="script"><link rel="prefetch" href="/notebook/assets/TextToSpeech_CMU_11492_692_Spring2023(Assignment8).html-mugYinQi.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html-xjN-GwTF.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html-IaNcm8K-.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_tutorial_2021_CMU_11751_18781.html-IMfnLI01.js" as="script"><link rel="prefetch" href="/notebook/assets/asr_cli.html-JH3saHIF.js" as="script"><link rel="prefetch" href="/notebook/assets/asr_library.html-nD4wSonE.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_asr_realtime_demo.html-31qj-nF8.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_asr_transfer_learning_demo.html-K8AGvfnJ.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_streaming_asr_demo.html-NgcmLWnC.js" as="script"><link rel="prefetch" href="/notebook/assets/onnx_conversion_demo.html-wfKipc9w.js" as="script"><link rel="prefetch" href="/notebook/assets/pretrained.html--Y7vPVCq.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet_se_demonstration_for_waspaa_2021.html-_RqduImg.js" as="script"><link rel="prefetch" href="/notebook/assets/se_demo.html-zhHwqNB_.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_2pass_slu_demo.html-SOe7ZUtq.js" as="script"><link rel="prefetch" href="/notebook/assets/st_demo.html-_JBPLyfl.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_tts_realtime_demo.html-9h1FXENI.js" as="script"><link rel="prefetch" href="/notebook/assets/tts_cli.html-OLkBd5Fu.js" as="script"><link rel="prefetch" href="/notebook/assets/tts_realtime_demo.html-Bgn0MtVH.js" as="script"><link rel="prefetch" href="/notebook/assets/finetune_with_lora.html-53DWrWT9.js" as="script"><link rel="prefetch" href="/notebook/assets/train.html-ZtrUU739.js" as="script"><link rel="prefetch" href="/notebook/assets/tacotron2.html-lMDTfHXx.js" as="script"><link rel="prefetch" href="/notebook/assets/404.html-6Yl8cQE3.js" as="script"><link rel="prefetch" href="/notebook/assets/index.html-Fa1mvKNA.js" as="script"><link rel="prefetch" href="/notebook/assets/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html-yZnfE8Rl.js" as="script"><link rel="prefetch" href="/notebook/assets/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html-EtOqTzx1.js" as="script"><link rel="prefetch" href="/notebook/assets/SpokenLanguageUnderstanding_CMU_11492_692_Spring2023(Assignment6).html-3QqySz0B.js" as="script"><link rel="prefetch" href="/notebook/assets/TextToSpeech_CMU_11492_692_Spring2023(Assignment8).html-oKNm4LpP.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html-4zeeKKut.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html-Xne2M8JW.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_tutorial_2021_CMU_11751_18781.html-HhdidVDJ.js" as="script"><link rel="prefetch" href="/notebook/assets/asr_cli.html-knKjgurg.js" as="script"><link rel="prefetch" href="/notebook/assets/asr_library.html-Kz7KwH4E.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_asr_realtime_demo.html-RYvF9e8R.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_asr_transfer_learning_demo.html-IksoduPb.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_streaming_asr_demo.html-6EF7rYtq.js" as="script"><link rel="prefetch" href="/notebook/assets/onnx_conversion_demo.html-1dXBgI7d.js" as="script"><link rel="prefetch" href="/notebook/assets/pretrained.html-bRY7ZLad.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet_se_demonstration_for_waspaa_2021.html-53aPYjLT.js" as="script"><link rel="prefetch" href="/notebook/assets/se_demo.html-0y7hJZOb.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_2pass_slu_demo.html-LPf_aa6M.js" as="script"><link rel="prefetch" href="/notebook/assets/st_demo.html-GjLoLXxU.js" as="script"><link rel="prefetch" href="/notebook/assets/espnet2_tts_realtime_demo.html-NCcWLTBY.js" as="script"><link rel="prefetch" href="/notebook/assets/tts_cli.html-Elg6sapX.js" as="script"><link rel="prefetch" href="/notebook/assets/tts_realtime_demo.html-wTutqUQW.js" as="script"><link rel="prefetch" href="/notebook/assets/finetune_with_lora.html-h3VNWfNm.js" as="script"><link rel="prefetch" href="/notebook/assets/train.html-zSf_6N6D.js" as="script"><link rel="prefetch" href="/notebook/assets/tacotron2.html-gzrp5q7X.js" as="script"><link rel="prefetch" href="/notebook/assets/404.html-8hkKDKOa.js" as="script"><link rel="prefetch" href="/notebook/assets/NpmBadge-ZlH3swud.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/notebook/" class=""><img class="logo" src="/notebook/images/espnet_logo1.png" alt="ESPnet-Example"><span class="site-name can-hide" aria-hidden="true">ESPnet-Example</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="ESPnet2"><span class="title">ESPnet2</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="ESPnet2"><span class="title">ESPnet2</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ASR</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/asr_cli.html" class="" aria-label="Speech Recognition (Recipe)"><!--[--><!--]--> Speech Recognition (Recipe) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/asr_library.html" class="" aria-label="Speech Recognition (Library)"><!--[--><!--]--> Speech Recognition (Library) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_asr_realtime_demo.html" class="" aria-label="ESPnet2-ASR realtime demonstration"><!--[--><!--]--> ESPnet2-ASR realtime demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_asr_transfer_learning_demo.html" class="" aria-label="Use transfer learning for ASR in ESPnet2"><!--[--><!--]--> Use transfer learning for ASR in ESPnet2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_streaming_asr_demo.html" class="" aria-label="ESPnet2 real streaming Transformer demonstration"><!--[--><!--]--> ESPnet2 real streaming Transformer demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>TTS</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/espnet2_tts_realtime_demo.html" class="" aria-label="ESPnet2-TTS realtime demonstration"><!--[--><!--]--> ESPnet2-TTS realtime demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/tts_cli.html" class="" aria-label="Text-to-Speech (Recipe)"><!--[--><!--]--> Text-to-Speech (Recipe) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/tts_realtime_demo.html" class="" aria-label="ESPnet real time E2E-TTS demonstration"><!--[--><!--]--> ESPnet real time E2E-TTS demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SE</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/se/se_demo.html" class="" aria-label="ESPnet Speech Enhancement Demonstration"><!--[--><!--]--> ESPnet Speech Enhancement Demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/se/espnet_se_demonstration_for_waspaa_2021.html" class="" aria-label="ESPnet Speech Enhancement Demonstration"><!--[--><!--]--> ESPnet Speech Enhancement Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SLU</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/slu/espnet2_2pass_slu_demo.html" class="" aria-label="ESPNET 2 pass SLU Demonstration"><!--[--><!--]--> ESPNET 2 pass SLU Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ST</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/st/st_demo.html" class="" aria-label="ESPnet Speech Translation Demonstration"><!--[--><!--]--> ESPnet Speech Translation Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Others</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/others/pretrained.html" class="" aria-label="Pretrained Model"><!--[--><!--]--> Pretrained Model <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/others/onnx_conversion_demo.html" class="" aria-label="espnet_onnx demonstration"><!--[--><!--]--> espnet_onnx demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Tutorials"><span class="title">Tutorials</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Tutorials"><span class="title">Tutorials</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notebook/tutorials/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html" class="" aria-label="CMU 11492/11692 Spring 2023: Data preparation"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Data preparation <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html" class="" aria-label="CMU 11751/18781 Fall 2022: ESPnet Tutorial2 (New task)"><!--[--><!--]--> CMU 11751/18781 Fall 2022: ESPnet Tutorial2 (New task) <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html" class="" aria-label="CMU 11751/18781 Fall 2022: ESPnet Tutorial"><!--[--><!--]--> CMU 11751/18781 Fall 2022: ESPnet Tutorial <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_tutorial_2021_CMU_11751_18781.html" class="" aria-label="CMU 11751/18781 2021: ESPnet Tutorial"><!--[--><!--]--> CMU 11751/18781 2021: ESPnet Tutorial <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html" class="" aria-label="CMU 11492/11692 Spring 2023: Speech Enhancement"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Speech Enhancement <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/SpokenLanguageUnderstanding_CMU_11492_692_Spring2023(Assignment6).html" class="" aria-label="CMU 11492/11692 Spring 2023: Spoken Language Understanding"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Spoken Language Understanding <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/TextToSpeech_CMU_11492_692_Spring2023(Assignment8).html" class="" aria-label="CMU 11492/11692 Spring 2023: Text to Speech"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Text to Speech <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="ESPnetEasy"><span class="title">ESPnetEasy</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="ESPnetEasy"><span class="title">ESPnetEasy</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ASR</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/asr/train.html" class="" aria-label="Sample demo for ESPnet-Easy!"><!--[--><!--]--> Sample demo for ESPnet-Easy! <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/asr/finetune_with_lora.html" class="" aria-label="Finetune Model with ESPnet-Easy"><!--[--><!--]--> Finetune Model with ESPnet-Easy <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html" class="router-link-active router-link-exact-active router-link-active" aria-label="OWSM finetuning with custom dataset"><!--[--><!--]--> OWSM finetuning with custom dataset <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>TTS</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/tts/tacotron2.html" class="" aria-label="TTS demo for ESPnet-Easy!"><!--[--><!--]--> TTS demo for ESPnet-Easy! <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="ESPnet2"><span class="title">ESPnet2</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="ESPnet2"><span class="title">ESPnet2</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ASR</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/asr_cli.html" class="" aria-label="Speech Recognition (Recipe)"><!--[--><!--]--> Speech Recognition (Recipe) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/asr_library.html" class="" aria-label="Speech Recognition (Library)"><!--[--><!--]--> Speech Recognition (Library) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_asr_realtime_demo.html" class="" aria-label="ESPnet2-ASR realtime demonstration"><!--[--><!--]--> ESPnet2-ASR realtime demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_asr_transfer_learning_demo.html" class="" aria-label="Use transfer learning for ASR in ESPnet2"><!--[--><!--]--> Use transfer learning for ASR in ESPnet2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/asr/espnet2_streaming_asr_demo.html" class="" aria-label="ESPnet2 real streaming Transformer demonstration"><!--[--><!--]--> ESPnet2 real streaming Transformer demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>TTS</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/espnet2_tts_realtime_demo.html" class="" aria-label="ESPnet2-TTS realtime demonstration"><!--[--><!--]--> ESPnet2-TTS realtime demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/tts_cli.html" class="" aria-label="Text-to-Speech (Recipe)"><!--[--><!--]--> Text-to-Speech (Recipe) <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/tts/tts_realtime_demo.html" class="" aria-label="ESPnet real time E2E-TTS demonstration"><!--[--><!--]--> ESPnet real time E2E-TTS demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SE</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/se/se_demo.html" class="" aria-label="ESPnet Speech Enhancement Demonstration"><!--[--><!--]--> ESPnet Speech Enhancement Demonstration <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/se/espnet_se_demonstration_for_waspaa_2021.html" class="" aria-label="ESPnet Speech Enhancement Demonstration"><!--[--><!--]--> ESPnet Speech Enhancement Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SLU</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/slu/espnet2_2pass_slu_demo.html" class="" aria-label="ESPNET 2 pass SLU Demonstration"><!--[--><!--]--> ESPNET 2 pass SLU Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ST</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/st/st_demo.html" class="" aria-label="ESPnet Speech Translation Demonstration"><!--[--><!--]--> ESPnet Speech Translation Demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Others</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/others/pretrained.html" class="" aria-label="Pretrained Model"><!--[--><!--]--> Pretrained Model <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnet2/others/onnx_conversion_demo.html" class="" aria-label="espnet_onnx demonstration"><!--[--><!--]--> espnet_onnx demonstration <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Tutorials"><span class="title">Tutorials</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Tutorials"><span class="title">Tutorials</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notebook/tutorials/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html" class="" aria-label="CMU 11492/11692 Spring 2023: Data preparation"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Data preparation <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html" class="" aria-label="CMU 11751/18781 Fall 2022: ESPnet Tutorial2 (New task)"><!--[--><!--]--> CMU 11751/18781 Fall 2022: ESPnet Tutorial2 (New task) <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html" class="" aria-label="CMU 11751/18781 Fall 2022: ESPnet Tutorial"><!--[--><!--]--> CMU 11751/18781 Fall 2022: ESPnet Tutorial <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/espnet2_tutorial_2021_CMU_11751_18781.html" class="" aria-label="CMU 11751/18781 2021: ESPnet Tutorial"><!--[--><!--]--> CMU 11751/18781 2021: ESPnet Tutorial <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html" class="" aria-label="CMU 11492/11692 Spring 2023: Speech Enhancement"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Speech Enhancement <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/SpokenLanguageUnderstanding_CMU_11492_692_Spring2023(Assignment6).html" class="" aria-label="CMU 11492/11692 Spring 2023: Spoken Language Understanding"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Spoken Language Understanding <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notebook/tutorials/TextToSpeech_CMU_11492_692_Spring2023(Assignment8).html" class="" aria-label="CMU 11492/11692 Spring 2023: Text to Speech"><!--[--><!--]--> CMU 11492/11692 Spring 2023: Text to Speech <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="ESPnetEasy"><span class="title">ESPnetEasy</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="ESPnetEasy"><span class="title">ESPnetEasy</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>ASR</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/asr/train.html" class="" aria-label="Sample demo for ESPnet-Easy!"><!--[--><!--]--> Sample demo for ESPnet-Easy! <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/asr/finetune_with_lora.html" class="" aria-label="Finetune Model with ESPnet-Easy"><!--[--><!--]--> Finetune Model with ESPnet-Easy <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html" class="router-link-active router-link-exact-active router-link-active" aria-label="OWSM finetuning with custom dataset"><!--[--><!--]--> OWSM finetuning with custom dataset <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>TTS</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/notebook/espnetez/tts/tacotron2.html" class="" aria-label="TTS demo for ESPnet-Easy!"><!--[--><!--]--> TTS demo for ESPnet-Easy! <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">ASR <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/notebook/espnetez/asr/train.html" class="sidebar-item" aria-label="Sample demo for ESPnet-Easy!"><!--[--><!--]--> Sample demo for ESPnet-Easy! <!--[--><!--]--></a><!----></li><li><a href="/notebook/espnetez/asr/finetune_with_lora.html" class="sidebar-item" aria-label="Finetune Model with ESPnet-Easy"><!--[--><!--]--> Finetune Model with ESPnet-Easy <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="OWSM finetuning with custom dataset"><!--[--><!--]--> OWSM finetuning with custom dataset <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#data-preparation" class="router-link-active router-link-exact-active sidebar-item" aria-label="Data Preparation"><!--[--><!--]--> Data Preparation <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#setup-training-configs-and-model" class="router-link-active router-link-exact-active sidebar-item" aria-label="Setup training configs and model"><!--[--><!--]--> Setup training configs and model <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#wrap-with-espneteasydataset" class="router-link-active router-link-exact-active sidebar-item" aria-label="Wrap with ESPnetEasyDataset"><!--[--><!--]--> Wrap with ESPnetEasyDataset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#training" class="router-link-active router-link-exact-active sidebar-item" aria-label="Training"><!--[--><!--]--> Training <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#inference" class="router-link-active router-link-exact-active sidebar-item" aria-label="Inference"><!--[--><!--]--> Inference <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notebook/espnetez/asr/finetune_owsm.html#results" class="router-link-active router-link-exact-active sidebar-item" aria-label="Results"><!--[--><!--]--> Results <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">TTS <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/notebook/espnetez/tts/tacotron2.html" class="sidebar-item" aria-label="TTS demo for ESPnet-Easy!"><!--[--><!--]--> TTS demo for ESPnet-Easy! <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="owsm-finetuning-with-custom-dataset" tabindex="-1"><a class="header-anchor" href="#owsm-finetuning-with-custom-dataset"><span>OWSM finetuning with custom dataset</span></a></h1><p>This Jupyter notebook provides a step-by-step guide on using the ESPnetEasy module to finetune owsm model. In this demonstration, we will leverage the custom dataset to finetune an OWSM model for ASR task.</p><h2 id="data-preparation" tabindex="-1"><a class="header-anchor" href="#data-preparation"><span>Data Preparation</span></a></h2><p>For this tutorial, we assume that we have the custom dataset with 654 audio with the following directory structure:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span>audio</span></span>
<span class="line"><span>├── 001 [420 entries exceeds filelimit, not opening dir]</span></span>
<span class="line"><span>└── 002 [234 entries exceeds filelimit, not opening dir]</span></span>
<span class="line"><span>transcription</span></span>
<span class="line"><span>└── owsm_v3.1</span></span>
<span class="line"><span>      ├── 001.csv</span></span>
<span class="line"><span>      └── 002.csv</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The csv files contains the audio path, text, and text_ctc data in Japanese. For example, the csv constains the following data:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span>audio/001/00014.wav,しゃべるたびに追いかけてくるんですけど,なんかしゃべるたびにおいかけてくるんですけど</span></span>
<span class="line"><span>audio/001/00015.wav,え、どうしよう,えどうしよう</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> os</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> glob </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> glob</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> numpy </span><span style="color:#C586C0;">as</span><span style="color:#D4D4D4;"> np</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> librosa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> torch</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> espnet2.bin.s2t_inference </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> Speech2Text</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> espnet2.layers.create_lora_adapter </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> create_lora_adapter</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> espnetez </span><span style="color:#C586C0;">as</span><span style="color:#D4D4D4;"> ez</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># Define hyper parameters</span></span>
<span class="line"><span style="color:#D4D4D4;">DUMP_DIR = </span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;./dump&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">CSV_DIR = </span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;./transcription&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">EXP_DIR = </span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;./exp/finetune&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">STATS_DIR = </span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;./exp/stats_finetune&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">FINETUNE_MODEL = </span><span style="color:#CE9178;">&quot;espnet/owsm_v3.1_ebf&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">LORA_TARGET = [</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;w_1&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;w_2&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;merge_proj&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">LANGUAGE = </span><span style="color:#CE9178;">&quot;jpn&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="setup-training-configs-and-model" tabindex="-1"><a class="header-anchor" href="#setup-training-configs-and-model"><span>Setup training configs and model</span></a></h2><p>Since we are going to finetune an OWSM model for ASR task, we will use the tokenizer and TokenIDConverter of the OWSM model. We will also use the training config as the default parameter sets, and update them with the finetuning configuration.</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">pretrained_model = Speech2Text.from_pretrained(</span></span>
<span class="line"><span style="color:#D4D4D4;">    FINETUNE_MODEL,</span></span>
<span class="line"><span style="color:#9CDCFE;">    category_sym</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;&lt;</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">LANGUAGE</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&gt;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    beam_size</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">) </span><span style="color:#6A9955;"># Load model to extract configs.</span></span>
<span class="line"><span style="color:#D4D4D4;">pretrain_config = </span><span style="color:#DCDCAA;">vars</span><span style="color:#D4D4D4;">(pretrained_model.s2t_train_args)</span></span>
<span class="line"><span style="color:#D4D4D4;">tokenizer = pretrained_model.tokenizer</span></span>
<span class="line"><span style="color:#D4D4D4;">converter = pretrained_model.converter</span></span>
<span class="line"><span style="color:#C586C0;">del</span><span style="color:#D4D4D4;"> pretrained_model</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">finetune_config = ez.config.update_finetune_config(</span></span>
<span class="line"><span style="color:#CE9178;">	&#39;s2t&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">	pretrain_config,</span></span>
<span class="line"><span style="color:#569CD6;">	f</span><span style="color:#CE9178;">&quot;./config/finetune_with_lora.yaml&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># define model loading function</span></span>
<span class="line"><span style="color:#569CD6;">def</span><span style="color:#DCDCAA;"> count_parameters</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">model</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#DCDCAA;"> sum</span><span style="color:#D4D4D4;">(p.numel() </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> p </span><span style="color:#C586C0;">in</span><span style="color:#D4D4D4;"> model.parameters() </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> p.requires_grad)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">def</span><span style="color:#DCDCAA;"> build_model_fn</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">args</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#D4D4D4;">    pretrained_model = Speech2Text.from_pretrained(</span></span>
<span class="line"><span style="color:#D4D4D4;">        FINETUNE_MODEL,</span></span>
<span class="line"><span style="color:#9CDCFE;">        category_sym</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;&lt;</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">LANGUAGE</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&gt;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">        beam_size</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">    model = pretrained_model.s2t_model</span></span>
<span class="line"><span style="color:#D4D4D4;">    model.train()</span></span>
<span class="line"><span style="color:#DCDCAA;">    print</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&#39;Trainable parameters: </span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">count_parameters(model)</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#6A9955;">    # apply lora</span></span>
<span class="line"><span style="color:#D4D4D4;">    create_lora_adapter(model, </span><span style="color:#9CDCFE;">target_modules</span><span style="color:#D4D4D4;">=LORA_TARGET)</span></span>
<span class="line"><span style="color:#DCDCAA;">    print</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&#39;Trainable parameters after LORA: </span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">count_parameters(model)</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#D4D4D4;"> model</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="wrap-with-espneteasydataset" tabindex="-1"><a class="header-anchor" href="#wrap-with-espneteasydataset"><span>Wrap with ESPnetEasyDataset</span></a></h2><p>Before initiating the training process, it is crucial to adapt the dataset to the ESPnet format. The dataset class should output tokenized text and audio files in <code>np.array</code> format.</p><p>Then let&#39;s define the custom dataset class. The owsm finetuning requires <code>audio</code>, <code>text</code>, <code>text_prev</code> and <code>text_ctc</code> data. You can use your custom-defined dataset, huggingface <code>datasets</code> library, or <code>lhotse</code> library, or any other dataloader that you want to use.</p><p>When you try to use custom-defined dataset, you should define the <code>data_info</code> dictionary. It defines the mapping between the output of your model and the input of ESPnet models.</p><p><strong>Note</strong>:</p><ul><li>Currently we do not support the custom dataloader that feeds processed feature.</li></ul><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">LANGUAGE = </span></span>
<span class="line"><span style="color:#6A9955;"># custom dataset class</span></span>
<span class="line"><span style="color:#569CD6;">class</span><span style="color:#4EC9B0;"> CustomDataset</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">torch</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">utils</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">data</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Dataset</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#569CD6;">    def</span><span style="color:#DCDCAA;"> __init__</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">self</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data_list</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#6A9955;">        # data_list is a list of tuples (audio_path, text, text_ctc)</span></span>
<span class="line"><span style="color:#569CD6;">        self</span><span style="color:#D4D4D4;">.data = data_list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    def</span><span style="color:#DCDCAA;"> __len__</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">self</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#DCDCAA;"> len</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">self</span><span style="color:#D4D4D4;">.data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    def</span><span style="color:#DCDCAA;"> __getitem__</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">self</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">idx</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#569CD6;"> self</span><span style="color:#D4D4D4;">._parse_single_data(</span><span style="color:#569CD6;">self</span><span style="color:#D4D4D4;">.data[idx])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    def</span><span style="color:#DCDCAA;"> _parse_single_data</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">self</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#D4D4D4;">        text = </span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;&lt;</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">LANGUAGE</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&gt;&lt;asr&gt;&lt;notimestamps&gt; </span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">d[</span><span style="color:#CE9178;">&#39;transcript&#39;</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#CE9178;">            &quot;audio_path&quot;</span><span style="color:#D4D4D4;">: d[</span><span style="color:#CE9178;">&quot;audio_path&quot;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#CE9178;">            &quot;text&quot;</span><span style="color:#D4D4D4;">: text,</span></span>
<span class="line"><span style="color:#CE9178;">            &quot;text_prev&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&quot;&lt;na&gt;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">            &quot;text_ctc&quot;</span><span style="color:#D4D4D4;">: d[</span><span style="color:#CE9178;">&#39;text_ctc&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">data_list = []</span></span>
<span class="line"><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> csv_file </span><span style="color:#C586C0;">in</span><span style="color:#DCDCAA;"> sorted</span><span style="color:#D4D4D4;">(glob(os.path.join(CSV_DIR, </span><span style="color:#CE9178;">&quot;*.csv&quot;</span><span style="color:#D4D4D4;">))):</span></span>
<span class="line"><span style="color:#C586C0;">    with</span><span style="color:#DCDCAA;"> open</span><span style="color:#D4D4D4;">(csv_file, </span><span style="color:#CE9178;">&quot;r&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">encoding</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;utf-8&quot;</span><span style="color:#D4D4D4;">) </span><span style="color:#C586C0;">as</span><span style="color:#D4D4D4;"> f:</span></span>
<span class="line"><span style="color:#D4D4D4;">        data_list += f.readlines()[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">:] </span><span style="color:#6A9955;"># skip header</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">validation_examples = </span><span style="color:#B5CEA8;">20</span></span>
<span class="line"><span style="color:#D4D4D4;">train_dataset = CustomDataset(data_list[:-validation_examples])</span></span>
<span class="line"><span style="color:#D4D4D4;">valid_dataset = CustomDataset(data_list[-validation_examples:])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">def</span><span style="color:#DCDCAA;"> tokenize</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#D4D4D4;"> np.array(converter.tokens2ids(tokenizer.text2tokens(text)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># The output of CustomDatasetInstance[idx] will converted to np.array</span></span>
<span class="line"><span style="color:#6A9955;"># with the functions defined in the data_info dictionary.</span></span>
<span class="line"><span style="color:#D4D4D4;">data_info = {</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;speech&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: librosa.load(d[</span><span style="color:#CE9178;">&quot;audio_path&quot;</span><span style="color:#D4D4D4;">], </span><span style="color:#9CDCFE;">sr</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">16000</span><span style="color:#D4D4D4;">)[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(d[</span><span style="color:#CE9178;">&quot;text&quot;</span><span style="color:#D4D4D4;">]),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_prev&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(d[</span><span style="color:#CE9178;">&quot;text_prev&quot;</span><span style="color:#D4D4D4;">]),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_ctc&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(d[</span><span style="color:#CE9178;">&quot;text_ctc&quot;</span><span style="color:#D4D4D4;">]),</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Or if you want to use <code>datasets</code> library or <code>lhotse</code> library:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;"># Datasets library</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> datasets </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> load_dataset, Audio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">train_dataset = load_dataset(</span><span style="color:#CE9178;">&quot;audiofolder&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data_dir</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;/path/to/huggingface_dataset&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">split</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&#39;train[:-</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">validation_examples</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">]&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">valid_dataset = load_dataset(</span><span style="color:#CE9178;">&quot;audiofolder&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data_dir</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;/path/to/huggingface_dataset&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">split</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&#39;train[-</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">validation_examples</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">:]&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">train_dataset = train_dataset.cast_column(</span><span style="color:#CE9178;">&quot;audio&quot;</span><span style="color:#D4D4D4;">, Audio(</span><span style="color:#9CDCFE;">sampling_rate</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">16000</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">valid_dataset = valid_dataset.cast_column(</span><span style="color:#CE9178;">&quot;audio&quot;</span><span style="color:#D4D4D4;">, Audio(</span><span style="color:#9CDCFE;">sampling_rate</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">16000</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">data_info = {</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;speech&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: d[</span><span style="color:#CE9178;">&#39;audio&#39;</span><span style="color:#D4D4D4;">][</span><span style="color:#CE9178;">&#39;array&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;&lt;</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">LANGUAGE</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&gt;&lt;asr&gt;&lt;notimestamps&gt; </span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">d[</span><span style="color:#CE9178;">&#39;transcript&#39;</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_prev&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(</span><span style="color:#CE9178;">&quot;&lt;na&gt;&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_ctc&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(d[</span><span style="color:#CE9178;">&quot;text_ctc&quot;</span><span style="color:#D4D4D4;">]),</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># Or lhotse library. The following code is from the official document.</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> pathlib </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> Path</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> lhotse </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> CutSet</span></span>
<span class="line"><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> lhotse.recipes </span><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> download_librispeech, prepare_librispeech</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">def</span><span style="color:#DCDCAA;"> load_audio</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">audio_path</span><span style="color:#D4D4D4;">):</span></span>
<span class="line"><span style="color:#D4D4D4;">    y, _ = librosa.load(audio_path, </span><span style="color:#9CDCFE;">sr</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">16000</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#D4D4D4;"> y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">root_dir = Path(</span><span style="color:#CE9178;">&quot;data&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">tmp_dir = Path(</span><span style="color:#CE9178;">&quot;tmp&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">tmp_dir.mkdir(</span><span style="color:#9CDCFE;">exist_ok</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">True</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">num_jobs = os.cpu_count() - </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">libri_variant = </span><span style="color:#CE9178;">&quot;mini_librispeech&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">libri_root = download_librispeech(root_dir, </span><span style="color:#9CDCFE;">dataset_parts</span><span style="color:#D4D4D4;">=libri_variant)</span></span>
<span class="line"><span style="color:#D4D4D4;">libri = prepare_librispeech(</span></span>
<span class="line"><span style="color:#D4D4D4;">    libri_root, </span><span style="color:#9CDCFE;">dataset_parts</span><span style="color:#D4D4D4;">=libri_variant, </span><span style="color:#9CDCFE;">output_dir</span><span style="color:#D4D4D4;">=root_dir, </span><span style="color:#9CDCFE;">num_jobs</span><span style="color:#D4D4D4;">=num_jobs</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">train_dataset = CutSet.from_manifests(**libri[</span><span style="color:#CE9178;">&quot;train-clean-5&quot;</span><span style="color:#D4D4D4;">])</span></span>
<span class="line"><span style="color:#D4D4D4;">valid_dataset = CutSet.from_manifests(**libri[</span><span style="color:#CE9178;">&quot;dev-clean-2&quot;</span><span style="color:#D4D4D4;">])</span></span>
<span class="line"><span style="color:#D4D4D4;">data_info = {</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;speech&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: load_audio(d.recording.sources[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].source),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(</span><span style="color:#569CD6;">f</span><span style="color:#CE9178;">&quot;&lt;</span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">LANGUAGE</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&gt;&lt;asr&gt;&lt;notimestamps&gt; </span><span style="color:#569CD6;">{</span><span style="color:#D4D4D4;">d.supervisions[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].text</span><span style="color:#569CD6;">}</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_prev&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(</span><span style="color:#CE9178;">&quot;&lt;na&gt;&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;text_ctc&quot;</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">lambda</span><span style="color:#9CDCFE;"> d</span><span style="color:#D4D4D4;">: tokenize(d.supervisions[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].text),</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And finally you need to wrap your custom dataset with ESPnetEasyDataset.</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;"># Convert into ESPnet-Easy dataset format</span></span>
<span class="line"><span style="color:#D4D4D4;">train_dataset = ez.dataset.ESPnetEasyDataset(train_dataset, </span><span style="color:#9CDCFE;">data_info</span><span style="color:#D4D4D4;">=data_info)</span></span>
<span class="line"><span style="color:#D4D4D4;">valid_dataset = ez.dataset.ESPnetEasyDataset(valid_dataset, </span><span style="color:#9CDCFE;">data_info</span><span style="color:#D4D4D4;">=data_info)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="training" tabindex="-1"><a class="header-anchor" href="#training"><span>Training</span></a></h2><p>While the configuration remains consistent with other notebooks, the instantiation arguments for the Trainer class differ in this case. As we have not generated dump files, we can disregard arguments related to dump files and directly provide the train/valid dataset classes.</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span>trainer = Trainer(</span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>    train_dataset=your_train_dataset_instance,</span></span>
<span class="line"><span>    train_dataset=your_valid_dataset_instance,</span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">trainer = ez.Trainer(</span></span>
<span class="line"><span style="color:#9CDCFE;">    task</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&#39;s2t&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    train_config</span><span style="color:#D4D4D4;">=finetune_config,</span></span>
<span class="line"><span style="color:#9CDCFE;">    train_dataset</span><span style="color:#D4D4D4;">=train_dataset,</span></span>
<span class="line"><span style="color:#9CDCFE;">    valid_dataset</span><span style="color:#D4D4D4;">=valid_dataset,</span></span>
<span class="line"><span style="color:#9CDCFE;">    build_model_fn</span><span style="color:#D4D4D4;">=build_model_fn, </span><span style="color:#6A9955;"># provide the pre-trained model</span></span>
<span class="line"><span style="color:#9CDCFE;">    data_info</span><span style="color:#D4D4D4;">=data_info,</span></span>
<span class="line"><span style="color:#9CDCFE;">    output_dir</span><span style="color:#D4D4D4;">=EXP_DIR,</span></span>
<span class="line"><span style="color:#9CDCFE;">    stats_dir</span><span style="color:#D4D4D4;">=STATS_DIR,</span></span>
<span class="line"><span style="color:#9CDCFE;">    ngpu</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">trainer.collect_stats()</span></span>
<span class="line"><span style="color:#D4D4D4;">trainer.train()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="inference" tabindex="-1"><a class="header-anchor" href="#inference"><span>Inference</span></a></h2><p>When training is done, we can use the inference API to generate the transcription, but don&#39;t forget to apply lora before loading the model!</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">DEVICE = </span><span style="color:#CE9178;">&quot;cuda&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">model = Speech2Text.from_pretrained(</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;espnet/owsm_v3.1_ebf&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    category_sym</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;&lt;jpn&gt;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    beam_size</span><span style="color:#D4D4D4;">=</span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    device</span><span style="color:#D4D4D4;">=DEVICE</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">create_lora_adapter(model.s2t_model, </span><span style="color:#9CDCFE;">target_modules</span><span style="color:#D4D4D4;">=LORA_TARGET)</span></span>
<span class="line"><span style="color:#D4D4D4;">model.s2t_model.eval()</span></span>
<span class="line"><span style="color:#D4D4D4;">d = torch.load(</span><span style="color:#CE9178;">&quot;./exp/finetune/1epoch.pth&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">model.s2t_model.load_state_dict(d)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="results" tabindex="-1"><a class="header-anchor" href="#results"><span>Results</span></a></h2><p>As a result, the finetuned owsm-v3.1 could successfully transcribe the audio files.</p><p><strong>Example</strong></p><ul><li>before finetune: 出してこの時間二のどりを。</li><li>after finetune: ダンスでこの世界に彩りを。</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav" aria-label="page navigation"><p class="inner"><span class="prev"><a href="/notebook/espnetez/asr/finetune_with_lora.html" class="" aria-label="Finetune Model with ESPnet-Easy"><!--[--><!--]--> Finetune Model with ESPnet-Easy <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/notebook/assets/app-FOR18dDf.js" defer></script>
  </body>
</html>
